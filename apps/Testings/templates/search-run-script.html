{% extends "base.html" %}
{% block title %}Run script{% endblock %}{% block subtitle %}Run script{% endblock %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col s12 l3">
                <div class="section">
                    <form id="filters">
                        <p>
                            <input name="group1" type="radio" id="keyword" class="with-gap" value="1" checked/>
                            <label for="keyword">Keywords</label>
                        </p>
                        <p>
                            <input name="group1" type="radio" id="testcase" value="2" class="with-gap"/>
                            <label for="testcase">Test Case</label>
                        </p>
                    </form>
                </div>
            </div>

            <div class="col s12  l1"></div>
            <div class="col s12  l4">
                <div class="section">
                    <label for="id_label_single">
                        Script Search
                        <select id="script-search"></select>
                    </label>
                </div>
                <div id="commandsContainer"></div>
            </div>

            <div class="col s12  l1"></div>
            <div class="card grey lighten-3 col s12 l3">
                <div class="section">
                    <div class="card-content">
                        <i>Select a <b>type script</b> and then <b>search</b> for a Script to Run it</i>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col s12 offset-l2 l8">
                <div class="section">
                    <div id="result_container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="viewModal" class="modal">
        <div class="modal-content">
            <h4 id="script_name_container"></h4>
            <div id="result">
            </div>
        </div>
    </div>
{% endblock %}

{% load staticfiles %}
{% load compress %}

{% block extraStyles %}
    {% compress css %}
        <link rel="stylesheet" href="{% static "css/select2-materialize.css" %}">
        <link rel="stylesheet" href="{% static "css/highlight.css" %}">
    {% endcompress %}
{% endblock %}

{% block extraScripts %}
    {% compress js %}
        <script type="text/javascript" src="{% static "js/select2.full.min.js" %}"></script>
        <script type="text/javascript">
            $('.modal').modal();

            $('#script-search').select2({
                ajax: {
                    url: "{% url "api-search-script" %}",
                    dataType: 'JSON',
                    delay: 350,
                    data: function (params) {
                        return {
                            name: params.term,
                            type_script: $("#filters input[type='radio']:checked").val()
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data
                        };
                    }
                },
                escapeMarkup: function (markup) {
                    return markup;
                }, // let our custom formatter work
                minimumInputLength: 2,
                templateResult: function (results) {
                    return results.name
                },
                templateSelection: function (selection) {
                    return selection.name;
                }
            });


            $('#script-search').on("select2:select", function (e) {
                $.ajax({
                    url: "{% url "api-search-script" %}",
                    type: 'GET',
                    dataType: 'JSON',
                    data: {
                        id_script: this.value,
                        type_script: $("#filters input[type='radio']:checked").val()
                    },
                    success: function (data) {

                        var _container = document.getElementById('result_container');
                        var _nameContainer = document.createElement('p');
                        var _descContainer = document.createElement('p');
                        var _dateContainer = document.createElement('p');
                        var _scriptTypeContainer = document.createElement('p');
                        var _types = ['Native', 'Imported'];

                        var _btnPreview = document.createElement('button');
                        var _btnUseIt = document.createElement('a');

                        _container.innerHTML = "";

                        _btnPreview.className += 'btn-flat blue-text waves-effect modal-trigger';
                        _btnUseIt.className += 'btn waves-effect';
                        _btnPreview.innerHTML = 'Preview Script';
                        _btnUseIt.innerHTML = 'Run It';
                        _btnUseIt.setAttribute('href', '/run/' + data.id + '/');

                        _btnPreview.setAttribute('data-target', 'viewModal');

                        getHighlight(data.id, $("#filters input[type='radio']:checked").val());

                        _nameContainer.innerHTML = 'Name: ' + data.name;
                        _descContainer.innerHTML = 'Description: ' + data.description;
                        _dateContainer.innerHTML = 'Created at: ' + new Date(data.created_at).toISOString().slice(0, 10);
                        _scriptTypeContainer.innerHTML = 'Script type Origin ' + _types[data.script_type - 1];

                        _container.appendChild(_nameContainer);
                        _container.appendChild(_descContainer);
                        _container.appendChild(_dateContainer);
                        _container.appendChild(_scriptTypeContainer);
                        _container.appendChild(_btnPreview);
                        _container.appendChild(_btnUseIt);

                    }, error: function (err) {
                        drawMessage(err, 'red');
                    }
                });
            });

            function getHighlight(_id, type_script) {
                var _script_container = document.getElementById('result');
                var _script_name_container = document.getElementById('script_name_container');
                _script_container.innerHTML = '';
                $.ajax({
                        url: "{% url "get-highlight" %}",
                        type: 'POST',
                        data: {
                            id_script: _id,
                            type_script: type_script
                        }, success: function (data) {
                            _script_container.innerHTML = data.script_result;
                            _script_name_container.innerHTML = "Preview Script";
                        }, error: function (err) {
                            drawMessage(err.text, 'red');
                        }
                    }
                )
            }
        </script>
    {% endcompress %}
{% endblock %}