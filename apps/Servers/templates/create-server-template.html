{% extends "base.html" %}
{% block title %}Create Server Template{% endblock %}
{% block subtitle %}Create Server Template{% endblock %}
{% block content %}
    <div class="container">
        <div class="row">
            <div class="col s12">
                <form novalidate>
                    {% csrf_token %}
                    {% include "form-snippet-horizontal.html" %}
                </form>
            </div>
        </div>

        <div class="row card">
            <div class="col s12 card-content">
                <h4 class="card-title">Parameters</h4>
                <div class="col s12 l4">
                    <div class="input-field">
                        <select id="parameter-search">
                        </select>
                    </div>
                    <div class="section">
                        <code class="blue-grey-text">
                            * You can add parameters if not found.
                        </code>
                        <br>
                    </div>
                    <div class="center">
                        <button type="button" class="btn-flat teal-text waves-effect" onclick="openParameterModal()">Add
                            Parameter
                        </button>
                    </div>
                </div>
                <div class="col s12 l1"></div>
                <div class="col s12 l7 hide" id="tableContainer">
                    <table>
                        <tr>
                            <th>Parameter</th>
                            <th>Help</th>
                            <th>Type</th>
                            <th></th>
                        </tr>
                        <tbody id="params_table"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
{% endblock %}
{% load staticfiles %}
{% block extraStyles %}
    <link rel="stylesheet" href="{% static "css/select2-materialize.css" %}">
{% endblock %}

{% block extraScripts %}
    <script type="text/javascript" src="{% static "js/select2.full.min.js" %}"></script>
    <script type="text/javascript">
        var global_params = [];
        var _objCont;
        var _types = ['String', 'List'];
        var _table_containenr = document.getElementById('tableContainer');

        $('#parameter-search').select2({
            ajax: {
                url: "{% url "api-parameters" %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        name: params.term,// search term
                        category: document.getElementById('id_category').value
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    };
                }
            },
            placeholder: "Command Search",
            escapeMarkup: function (markup) {
                return markup;
            }, // let our custom formatter work
            minimumInputLength: 2,
            templateResult: function (data) {
                return data.name
            },
            templateSelection: function (data) {
                return data.name
            }
        });

        $('#parameter-search').on("select2:select", function (e) {
            populateObj($('#parameter-search').select2('data')[0])
        });


        function populateObj(data) {
            global_params.push({
                "id": data.id,
                "name": data.name,
                "help_text": data.help_text,
                "category": data.category,
                "value_type": data.value_type
            });
            if (!_objCont) {
                _objCont = 0;
            }
            _table_containenr.classList.remove("hide");
            drawParamter(data);
        }

        function drawParamter(data) {
            var _tr_params = document.createElement('tr');
            var _td_param = document.createElement('td');
            var _td_help = document.createElement('td');
            var _td_type = document.createElement('td');
            var _td_option = document.createElement('td');
            var _delete_icon = document.createElement('i');

            _tr_params.setAttribute('id', _objCont);

            _delete_icon.setAttribute('class', 'material-icons red-text');
            _delete_icon.setAttribute('onClick', 'deleteParam(' + _objCont + ')');
            _delete_icon.appendChild(document.createTextNode('close'));

            _td_param.appendChild(document.createTextNode(data.name));
            _td_help.appendChild(document.createTextNode(data.help_text));
            _td_type.appendChild(document.createTextNode(data.value_type));
            _td_option.appendChild(_delete_icon);

            _tr_params.appendChild(_td_param);
            _tr_params.appendChild(_td_help);
            _tr_params.appendChild(_td_type);
            _tr_params.appendChild(_td_option);

            document.getElementById('params_table').appendChild(_tr_params);
            _objCont++;
        }

        function deleteParam(id) {
            /* Delete the param row (tr)*/
            var _element = document.getElementById(id);
            global_params.splice(id, 1);
            _objCont--;
            _element.parentNode.removeChild(_element);
        }

        document.getElementById("id_category").onchange = cleanGlobalParams;


        function cleanGlobalParams() {
            global_params = [];
            var table = document.getElementById('params_table');
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            }
        }

        function openParameterModal() {
            alert('Cuando sea grande quiero ser un modal!')
        }
    </script>
{% endblock %}